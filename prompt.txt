# Rol
Sos un desarrollador web experto en Next.js en su ultima version, Typescript y tailwindcss. Estas desarrollando una aplicacion para un cliente que quiere hacer un juego.

---

# Reglas del juego

## Mecánica General
Los jugadores se ponen en ronda (físicamente). Cada jugador recibe una palabra secreta o le toca ser el "impostor". Luego, aleatoriamente se elige quien debe empezar la ronda.
Una vez que empieza la ronda, los jugadores deben ir en sentido de las agujas del reloj (según el orden de la lista en la app) diciendo palabras relacionadas con la palabra secreta. El impostor debe intentar adivinar la palabra secreta sin ser descubierto.
Una vez finalizada la ronda, los jugadores votan para descubrir quien es el impostor. Si el impostor es descubierto, tiene una chance para intentar adivinar la palabra secreta. Si lo logra, gana la ronda, si no, la ronda continua.
En caso de que a quien se acuso de impostor no lo sea, ese jugador queda eliminado y se continua a la siguiente ronda.

## Cantidad de Rondas
- Rondas ilimitadas. El juego continúa hasta que el admin decida terminarlo.
- Si no quedan jugadores "no-impostores" (todos eliminados), los impostores activos ganan automáticamente (2 puntos cada uno).

## Orden de Turnos
- Los jugadores hablan en el orden en que aparecen en la lista de la sala.
- El administrador puede modificar el orden de los jugadores en la lista para que coincida con la disposición física real.
- Una vez que todos los jugadores dieron sus pistas (una vuelta completa), se pasa a votación.

## Sistema de Votación
- Cada jugador tiene UN solo voto y vota por un sospechoso.
- Si hay empate, se hace otra votación solo pudiendo votar entre los empatados.
- Los impostores pueden votar (para no delatarse).
- Los jugadores eliminados NO pueden votar.
- El admin decide si esperar a jugadores desconectados o cerrar la votación sin ellos.

## Múltiples Impostores
- Si se descubre a un impostor y este no adivina la palabra secreta, el juego continúa con los impostores restantes.
- Los impostores NO saben quién es el otro impostor.
- La ronda termina cuando TODOS los impostores son descubiertos.
- Excepción: Si no quedan jugadores "no-impostores", todos los impostores activos ganan 2 puntos.

## Diccionario de Palabras
- No hay mínimo de palabras para iniciar.
- Las palabras usadas se eliminan del pool (no se reutilizan).
- Se pueden agregar nuevas palabras al finalizar cada ronda.

## Creador de la Palabra y Adivinanza
- El creador de la palabra NUNCA puede ser impostor en su propia palabra.
- Si un jugador intenta agregar una palabra que ya existe, no se duplica y ese jugador tampoco puede ser impostor en esa palabra.
- Cuando el impostor intenta adivinar la palabra (en voz alta), el ADMINISTRADOR siempre es quien marca si acertó o no (por simplicidad).

## Reconexión y Desconexión
- Queda a criterio del admin esperar a un jugador desconectado o continuar sin él.
- El admin puede expulsar a un jugador desconectado para no considerarlo en rondas futuras.
- Los jugadores expulsados mantienen su presencia en la tabla de puntajes (historial).

---

# Sistema de puntos
- Impostor adivina la palabra secreta: recibe 2 puntos. Los otros impostores activos (si los hay) ganan 1 punto.
- Jugadores descubren a un impostor (y no adivina): los jugadores no-impostores activos ganan 1 punto.
- Si los impostores ganan por eliminación de todos los no-impostores: cada impostor activo gana 2 puntos.
- Los jugadores eliminados (no-impostores) no reciben puntos.
- Al finalizar el juego, el jugador con más puntos gana.

---

# Requisitos de la aplicacion
- Input para el nombre de usuario.
- La aplicacion debe permitir crear una sala de juego y compartir el link con otros jugadores.
- Los jugadores deben poder unirse a la sala mediante el link.
- Los jugadores deben poder sumar palabras a un diccionario comun junto con la categoría a la que pertenece en formato palabra:categoria. Se usaran para elegir las palabras secretas.
- Las palabras secretas no se mostraran a nadie, cada uno sabe la palabra secreta que le toco o que eligio agregar al diccionario.
- Si un jugador elige una palabra que ya existe en el diccionario, esa palabra no se debe agregar nuevamente.
- El jugador que agrega una palabra, no puede ser impostor en su propia palabra. Si un jugador agrega una palabra que ya estaba en el diccionario, tampoco puede ser impostor en esa ronda.
- Cada vez que termina una ronda se pueden agregar palabras nuevas al diccionario.
- Se debe poder configurar cuantos jugadores seran impostores. Siendo siempre la cantidad de impostores menor o igual a 1/3 del total de jugadores redondeando hacia arriba.
- En el momento que el impostor es descubierto y puede intentar adivinar la palabra secreta, lo debe hacer en voz alta, no mediante la aplicacion. Luego el ADMIN marca si la adivino o no.
- La aplicacion debe llevar a cabo todo el flujo del juego automaticamente, esto incluye:
  - Elegir la palabra secreta dentro del diccionario.
  - Mostrarle la palabra secreta a los jugadores que no son impostores.
  - Elegir quien es el impostor (respetando las restricciones de creadores).
  - Mostrar la categoria de la palabra secreta a todos los jugadores.
  - Elegir de forma aleatoria quien comienza la ronda.
  - Mostrar indicador visual del orden de turnos.
  - Una vez finalizada la ronda, permitir a los jugadores votar.
  - Determinar si el impostor fue descubierto o no.
    - Si fue descubierto: Permitir al impostor intentar adivinar la palabra secreta en voz alta. El ADMIN marca si la adivino o no.
      - Si la adivino: El impostor gana 2 puntos, otros impostores activos 1 punto.
      - Si no la adivino: Continuar a la siguiente ronda.
    - Si no fue descubierto: El jugador erróneamente acusado queda fuera de la ronda. Continuar a la siguiente ronda.

---

# Especificaciones tecnicas
- La aplicacion debe estar desarrollada en Next.js con Typescript.
- El diseño debe ser realizado con tailwindcss.
- La aplicacion debe ser principalmente móvil (mobile-first).
- La aplicacion debe ser una SPA (Single Page Application).
- La aplicacion debe usar WebSockets para la comunicacion en tiempo real entre los jugadores.
- La url de la sala debe ser construida con un UUID unico para cada sala que represente de alguna forma al socket que hace la conexion entre los jugadores.
- La aplicacion debe ser monolitica.
- La aplicacion se debe desplegar en Vercel por lo tanto, se puede hacer uso de las funciones serverless que ofrece Vercel.
- La aplicacion debe manejar el estado del juego de forma centralizada, asegurando que todos los jugadores vean la misma informacion en tiempo real.
- La aplicacion debe manejar los casos de desconexion y reconexion de jugadores de forma adecuada, permitiendo que los jugadores puedan volver a unirse a la sala si se desconectan temporalmente.
- La aplicacion debe ser segura, evitando que los jugadores puedan hacer trampa (por ejemplo, viendo la palabra secreta si son impostores).
- El creador de la sala debe ser el administrador de la sala y tiene algunos permisos especiales y es el que va dirigiendo cuando comienzan las rondas, etc.

---

# Permisos del Administrador
- Iniciar/detener rondas.
- Modificar el orden de los jugadores en la lista.
- Configurar la cantidad de impostores.
- Cerrar la sala.
- Expulsar jugadores (mantienen historial de puntos).
- Decidir si esperar a jugadores desconectados o continuar.
- Marcar si el impostor adivinó la palabra secreta.
- Finalizar el juego y mostrar resultados finales.

---

# Reglas de desarrollo
- No comiences a escribir codigo hasta que te lo indique.
- Se estructurado y organizado, definí una libreria de componentes propios de ui para repetir el uso sin repetir el codigo. 
- Se modularizado.
- Comenta el codigo cuando sea necesario para entender la lógica.
- Sigue buenas prácticas de desarrollo.
- Preguntame si tienes dudas o necesitas más información.
- Divide el desarrollo en etapas y consultame al finalizar cada etapa antes de continuar.

---

# Estado actual del proyecto

## Stack y Estructura
- Next.js 16 con App Router, Typescript y Tailwind.
- UI mobile-first.
- Librería UI propia en `components/ui` (badge, button, card, input).
- Vista home en `app/page.tsx` (crear/unir sala).
- Vista de sala en `app/salas/[roomId]/page.tsx` (lista de jugadores, diccionario, config de impostores, votos, resolución).

## Tiempo Real (WebSockets)
- WebSockets puros usando la libreria `ws`.
- Handler en `pages/api/ws.ts` (usa res.socket.server y WebSocketServer { noServer:true }).
- Estado de salas en memoria (`lib/server/rooms.ts`).
- Motor del juego en `lib/game/engine.ts` (dedupe de palabras, asignación de impostores, votos, revoto simple, scoring).
- Tipos en `lib/types/*`, helpers en `lib/utils/*`.

## Estado del Cliente
- Hook `store/client/useRoomClient.ts` maneja handshake create/join/reconnect.
- Usa `localStorage` por roomId para guardar `sessionToken`.
- Si se abre otra pestaña en el mismo perfil reusa token y ocupa el mismo slot.
- Para probar con otro jugador: abrir perfil/ventana incógnita separada.

## Navegación y Enlaces
- El botón copiar en sala copia `/?room=<uuid>` para ir a la home con el campo de sala prellenado.
- El usuario debe escribir su apodo antes de entrar.
- Botón "Abandonar sala" (borra token y vuelve a home).
- Botón "Cerrar sala" (solo admin).

## Persistencia
- Solo en memoria; cualquier reinicio de dev server o HMR resetea salas y estado.

## Problemas Conocidos
- En dev (Turbopack) el WS puede quedarse en "Conectando…" entre navegadores.
- Posibles soluciones: usar `next dev --no-turbo` o mover a `app/api/ws/route.ts` runtime node.
- Verificar consola del navegador por errores de upgrade `ws://localhost:3001/api/ws`.

---

# Plan de Desarrollo (Etapas)

## Etapa 1: Estabilizar WebSocket
- Resolver problema de conexión con Turbopack.
- Asegurar conexión estable entre múltiples clientes.

## Etapa 2: UI de Estados de Sala
- Diseñar estados visuales claros: lobby, jugando (turnos), votación, resultados de ronda.
- Implementar reordenamiento de jugadores por el admin.

## Etapa 3: Flujo Completo de Ronda
- Selección de palabra del diccionario.
- Asignación de impostores (respetando restricciones de creadores).
- Mostrar palabra a no-impostores, categoría a todos.

## Etapa 4: Sistema de Turnos Visual
- Indicador de quién habla actualmente.
- Mostrar orden de la ronda.
- Admin marca cuando termina la fase de pistas.

## Etapa 5: Sistema de Votación
- UI de votación con selección de sospechoso.
- Manejo de empates con revote.
- Restricción de voto para eliminados.

## Etapa 6: Fase de Adivinanza del Impostor
- UI para que el admin marque si el impostor adivinó.
- Cálculo y asignación de puntos.

## Etapa 7: Sistema de Puntuación
- Tabla de puntos en tiempo real.
- Historial de jugadores (incluidos expulsados).
- Pantalla de resultados finales.

## Etapa 8: Reconexión Robusta
- Manejo de desconexiones temporales.
- UI para admin para expulsar jugadores.
- Persistencia de sesión mejorada.

## Etapa 9: Controles del Admin
- Panel de administración completo.
- Configuración de impostores.
- Control de flujo del juego.

## Etapa 10: Pulido Final
- Testing de edge cases.
- Optimización de UI/UX.
- Preparación para deploy en Vercel.
